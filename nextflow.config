// Config with three profiles: local, dsi (docker), imperial (singularity/cluster)
// Added per-process container for QC_INTERSECT (R/Seurat) while keeping the template structure.

profiles {

    // Local development / production with Docker; QC_INTERSECT uses R image
    local {
        process {
            executor = 'local'
            cpus = 40
            memory = '120 GB'
            time = { 24.h * task.attempt }
            errorStrategy = 'retry'
            maxRetries = 1
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy'; containerOptions = '--entrypoint=' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6'; stageInMode = 'copy'; containerOptions = '--entrypoint=' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6'; stageInMode = 'copy'; containerOptions = '--entrypoint=' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy'; containerOptions = '--entrypoint=' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:REPORT          { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:PILEUP         { stageInMode = 'copy' }
            withName:DEMUXLET       { stageInMode = 'copy' }
        }
        docker.enabled = true
        singularity.enabled = false
    }

    // Standard alias (same as local)
    standard {
        process {
            executor = 'local'
            cpus = 40
            memory = '120 GB'
            time = { 24.h * task.attempt }
            errorStrategy = 'retry'
            maxRetries = 1
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:REPORT          { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:PILEUP         { stageInMode = 'copy' }
            withName:DEMUXLET       { stageInMode = 'copy' }
        }
        docker.enabled = true
        singularity.enabled = false
    }

    // Docker-enabled test profile (kept from template)
    dsi {
        docker.enabled = true
        process {
            executor = 'local'
            cpus = 40
            memory = '120 GB'
            time = { 24.h * task.attempt }
            errorStrategy = 'retry'
            maxRetries = 1
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:REPORT          { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:PILEUP         { stageInMode = 'copy' }
            withName:DEMUXLET       { stageInMode = 'copy' }
        }
    }

    // Imperial/HPC Singularity profile (template preserved)
    imperial {
        docker.enabled = false
        singularity {
            enabled = true
            autoMounts = true
        }

        process {
            executor = 'pbspro'
            errorStrategy = 'retry'
            maxRetries = 5
            maxErrors = '-1'
            cpus = { 1 * task.attempt }
            memory = { 6.GB * task.attempt }
            time = { 4.h * task.attempt }

            withLabel:process_single { cpus = 1; memory = { 6.GB * task.attempt }; time = { 4.h * task.attempt }}
            withLabel:process_low    { cpus = { 2 * task.attempt }; memory = { 12.GB * task.attempt }; time = { 2.h * task.attempt }}
            withLabel:process_medium { cpus = { 8 * task.attempt }; memory = { 32.GB * task.attempt }; time = { 8.h * task.attempt }}
            withLabel:process_high   { cpus = { 16 * task.attempt }; memory = { 64.GB * task.attempt }; time = { 24.h * task.attempt }}

            withLabel:process_dropletqc { cpus = 30; memory = '80.GB'; time = '2.h'}
            withLabel:process_seurat    { cpus = 10; memory = '80.GB'; time = '2.h'}
            withLabel:process_reports   { cpus = 8;  memory = '20.GB'; time = '1.h'}
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6'; stageInMode = 'copy' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:REPORT          { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
            withName:PILEUP         { stageInMode = 'copy' }
            withName:DEMUXLET       { stageInMode = 'copy' }
        }
    }

}

// Minimal params section (overridden by CLI)
params {
    pools_csv = "pools.csv"
    pop_vcf   = "/home/pr422/RDS/live/Users/Parisa/alex_output/GRCh38_1000G_MAF0.01_GeneFiltered_ChrEncoding.vcf.gz"
    ref_fasta = "/home/pr422/RDS/live/Users/Parisa/refrence_genome/human/refdata-gex-GRCh38-2024-A/fasta/genome.fa"
    doublet_prior = 0.05
    geno_error_offset = 0.15
    geno_error_coeff  = 0.0
    alphas = "0,0.5"
    pileup_script = "${projectDir}/scripts/01_run_pileup_1000G.sh"
    demux_script  = "${projectDir}/scripts/02_run_demuxlet_sweep.sh"
    qc_intersect_R = "${projectDir}/scripts/qc_intersect.R"
}
