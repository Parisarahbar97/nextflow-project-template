// Config with three profiles: local, dsi (docker), imperial (singularity/cluster)
// Added per-process container for QC_INTERSECT (R/Seurat) while keeping the template structure.

profiles {

    // Local development / production with Docker; QC_INTERSECT uses R image
    local {
        process {
            executor = 'local'
            cpus = 1
            memory = '4 GB'
            time = { 1.h * task.attempt }
            errorStrategy = 'finish'
            withName:NORMALIZE_POP   { container = 'parisa/genotype:2.6' }
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
        }
        docker.enabled = true
        singularity.enabled = false
    }

    // Standard alias (same as local)
    standard {
        process {
            executor = 'local'
            cpus = 1
            memory = '4 GB'
            time = { 1.h * task.attempt }
            errorStrategy = 'finish'
            withName:NORMALIZE_POP   { container = 'parisa/genotype:2.6' }
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
        }
        docker.enabled = true
        singularity.enabled = false
    }

    // Docker-enabled test profile (kept from template)
    dsi {
        docker.enabled = true
        process {
            executor = 'local'
            cpus = 2
            memory = '8 GB'
            time = { 2.h * task.attempt }
            errorStrategy = 'retry'
            maxRetries = 2
            withName:NORMALIZE_POP   { container = 'parisa/genotype:2.6' }
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
        }
    }

    // Imperial/HPC Singularity profile (template preserved)
    imperial {
        docker.enabled = false
        singularity {
            enabled = true
            autoMounts = true
        }

        process {
            executor = 'pbspro'
            errorStrategy = 'retry'
            maxRetries = 5
            maxErrors = '-1'
            cpus = { 1 * task.attempt }
            memory = { 6.GB * task.attempt }
            time = { 4.h * task.attempt }

            withLabel:process_single { cpus = 1; memory = { 6.GB * task.attempt }; time = { 4.h * task.attempt }}
            withLabel:process_low    { cpus = { 2 * task.attempt }; memory = { 12.GB * task.attempt }; time = { 2.h * task.attempt }}
            withLabel:process_medium { cpus = { 8 * task.attempt }; memory = { 32.GB * task.attempt }; time = { 8.h * task.attempt }}
            withLabel:process_high   { cpus = { 16 * task.attempt }; memory = { 64.GB * task.attempt }; time = { 24.h * task.attempt }}

            withLabel:process_dropletqc { cpus = 30; memory = '80.GB'; time = '2.h'}
            withLabel:process_seurat    { cpus = 10; memory = '80.GB'; time = '2.h'}
            withLabel:process_reports   { cpus = 8;  memory = '20.GB'; time = '1.h'}
            withName:NORMALIZE_POP   { container = 'parisa/genotype:2.6' }
            withName:NORMALIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:INTERSECT_SITES { container = 'parisa/genotype:2.6' }
            withName:REHEADER_SITES  { container = 'parisa/genotype:2.6' }
            withName:HARMONIZE_DONOR { container = 'parisa/genotype:2.6' }
            withName:QC_INTERSECT    { container = 'ghcr.io/johnsonlab-ic/sc_analysis:latest' }
        }
    }

}

// Minimal params section (overridden by CLI)
params {
    pools_csv = "pools.csv"
}
